#!/bin/bash
set -e

echo "Waiting for YARN ResourceManager to be ready..."

sleep 5

until timeout 5 yarn node -list 2>/dev/null | grep -q "RUNNING"; do
  echo "Waiting for YARN NodeManager to register with ResourceManager..."
  sleep 1
done

echo "YARN is ready. Starting HiveServer2..."

echo "--- HDFS Initialization ---"

# --- Create HDFS directories idempotently ---
if ! hdfs dfs -test -d hdfs://namenode/tmp; then
  echo "Directory hdfs://namenode/tmp not found, creating..."
  hdfs dfs -mkdir -p hdfs://namenode/tmp
else
  echo "Directory hdfs://namenode/tmp already exists."
fi
hdfs dfs -chmod -R 1777 hdfs://namenode/tmp

if ! hdfs dfs -test -d hdfs://namenode/tmp/hive; then
  echo "Directory hdfs://namenode/tmp/hive not found, creating..."
  hdfs dfs -mkdir -p hdfs://namenode/tmp/hive
else
  echo "Directory hdfs://namenode/tmp/hive already exists."
fi
hdfs dfs -chmod -R 1777 hdfs://namenode/tmp/hive

if ! hdfs dfs -test -d hdfs://namenode/tmp/yarn; then
  echo "Directory hdfs://namenode/tmp/yarn not found, creating..."
  hdfs dfs -mkdir -p hdfs://namenode/tmp/yarn
else
  echo "Directory hdfs://namenode/tmp/yarn already exists."
fi
hdfs dfs -chmod -R 1777 hdfs://namenode/tmp/yarn

if ! hdfs dfs -test -d hdfs://namenode/tmp/logs; then
  echo "Directory hdfs://namenode/tmp/logs not found, creating..."
  hdfs dfs -mkdir -p hdfs://namenode/tmp/logs
else
  echo "Directory hdfs://namenode/tmp/logs already exists."
fi
hdfs dfs -chmod -R 1777 hdfs://namenode/tmp/logs

if ! hdfs dfs -test -d hdfs://namenode/user/$HIVE_USER_NAME/warehouse; then
  echo "Directory hdfs://namenode/user/$HIVE_USER_NAME/warehouse not found, creating..."
  hdfs dfs -mkdir -p hdfs://namenode/user/$HIVE_USER_NAME/warehouse
else
  echo "Directory hdfs://namenode/user/$HIVE_USER_NAME/warehouse already exists."
fi
hdfs dfs -chmod -R 1777 hdfs://namenode/user/$HIVE_USER_NAME/warehouse

# --- Set ownership ---
echo "Ensuring '$HIVE_USER_NAME' user owns hdfs://namenode/user/$HIVE_USER_NAME..."
hdfs dfs -chown -R $HIVE_USER_NAME:$HIVE_USER_NAME hdfs://namenode/user/$HIVE_USER_NAME

echo "Uploading Tez bundle to HDFS"

TEZ_HDFS_DIR=hdfs://namenode/apps/tez
TEZ_TAR_FILE=/tmp/tez.tar.gz

if ! hdfs dfs -test -d $TEZ_HDFS_DIR; then
  echo "Creating Tez HDFS directory: $TEZ_HDFS_DIR"
  hdfs dfs -mkdir -p $TEZ_HDFS_DIR
  echo "Uploading Tez bundle to HDFS..."
  tar czf $TEZ_TAR_FILE -C /opt/tez .
  hdfs dfs -put -f $TEZ_TAR_FILE $TEZ_HDFS_DIR/
else
  echo "Tez HDFS directory already exists."
fi

echo "Initialization complete."

schematool -dbType derby -initSchema
sh -c /entrypoint.sh
