name: Build Dispatcher

on:
  push:
    branches:
      - main
    paths:
      - 'containers/**'

jobs:
  determine-changes:
    runs-on: ubuntu-latest
    outputs:
      base-root-config-bat: ${{ steps.filter.outputs.base-root-config-bat }}
      base-root-config-glamour: ${{ steps.filter.outputs.base-root-config-glamour }}
      base-root-config-micro: ${{ steps.filter.outputs.base-root-config-micro }}
      base-root-config-emacs: ${{ steps.filter.outputs.base-root-config-emacs }}
      base-root-config-nvim: ${{ steps.filter.outputs.base-root-config-nvim }}
      build-base-root: ${{ steps.consolidate.outputs.build_base_root }}
      build-base: ${{ steps.consolidate.outputs.build_base }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use paths-filter action
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            base-root-config-bat:
              - 'containers/base/root/.config/bat/**'
            base-root-config-glamour:
              - 'containers/base/root/.config/glamour/**'
            base-root-config-micro:
              - 'containers/base/root/.config/micro/**'
            base-root-config-emacs:
              - 'containers/base/root/.config/emacs/**'
            base-root-config-nvim:
              - 'containers/base/root/.config/nvim/**'
            base-root:
              - 'containers/base/root/**'
            base:
              - 'containers/base/**'

      # This step precomputes logic chains that determine whether cotnainers with dependencies build
      - name: Consolidate change logic
        id: consolidate
        run: |
          # Determine if any "leaf" file (i.e: configs) changed
          base_root_config_changed='false'
          if [[ "${{ steps.filter.outputs.base-root-config-bat }}" == 'true' || \
                "${{ steps.filter.outputs.base-root-config-glamour }}" == 'true' || \
                "${{ steps.filter.outputs.base-root-config-micro }}" == 'true' || \
                "${{ steps.filter.outputs.base-root-config-emacs }}" == 'true' || \
                "${{ steps.filter.outputs.base-root-config-nvim }}" == 'true' ]]; then
            base_root_config_changed='true'
          fi

          # Determine if the 'base-root' container should be built
          build_base_root='false'
          if [[ "${{ steps.filter.outputs.base-root }}" == 'true' || "$base_root_config_changed" == 'true' ]]; then
            build_base_root='true'
          fi
          echo "build_base_root=$build_base_root" >> $GITHUB_OUTPUT

          # Determine if the 'base' container should be built
          build_base='false'
          if [[ "${{ steps.filter.outputs.base }}" == 'true' || "$build_base_root" == 'true' ]]; then
            build_base='true'
          fi
          echo "build_base=$build_base" >> $GITHUB_OUTPUT

  build-base-root-config-bat:
    needs: determine-changes
    if: needs.determine-changes.outputs.base-root-config-bat == 'true'
    name: 'Build base-root-config-bat container'
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/build.yml
    with:
      path: containers/base/root/.config/bat
    secrets: inherit

  build-base-root-config-glamour:
    needs: determine-changes
    if: needs.determine-changes.outputs.base-root-config-glamour == 'true'
    name: 'Build base-root-config-glamour container'
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/build.yml
    with:
      path: containers/base/root/.config/glamour
    secrets: inherit

  build-base-root-config-micro:
    needs: determine-changes
    if: needs.determine-changes.outputs.base-root-config-micro == 'true'
    name: 'Build base-root-config-micro container'
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/build.yml
    with:
      path: containers/base/root/.config/micro
    secrets: inherit

  build-base-root-config-emacs:
    needs: determine-changes
    if: needs.determine-changes.outputs.base-root-config-emacs == 'true'
    name: 'Build base-root-config-emacs container'
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/build.yml
    with:
      path: containers/base/root/.config/emacs
    secrets: inherit

  build-base-root-config-nvim:
    needs: determine-changes
    if: needs.determine-changes.outputs.base-root-config-nvim == 'true'
    name: 'Build base-root-config-nvim container'
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/build.yml
    with:
      path: containers/base/root/.config/nvim
    secrets: inherit

  build-base-root:
    needs:
      - determine-changes
      - build-base-root-config-bat
      - build-base-root-config-glamour
      - build-base-root-config-micro
      - build-base-root-config-emacs
      - build-base-root-config-nvim
    if: >-
      needs.determine-changes.outputs.build-base-root == 'true' &&
      !contains(fromJSON('["${{ needs.build-base-root-config-bat.result }}",
                            "${{ needs.build-base-root-config-glamour.result }}",
                            "${{ needs.build-base-root-config-micro.result }}",
                            "${{ needs.build-base-root-config-emacs.result }}",
                            "${{ needs.build-base-root-config-nvim.result }}"]'), 'failure')
    name: 'Build base-root container'
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/build.yml
    with:
      path: containers/base/root/
    secrets: inherit

  build-base:
    needs:
      - determine-changes
      - build-base-root
    if: >-
      needs.determine-changes.outputs.build-base == 'true' &&
      needs.build-base-root.result != 'failure'
    name: 'Build base container'
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/build.yml
    with:
      path: containers/base/
    secrets: inherit
